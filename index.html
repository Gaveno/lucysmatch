<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LUCY'S MATCH</title>
  <!-- Playful font -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- External CSS Files -->
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/hud.css">
  <link rel="stylesheet" href="css/modals.css">
  <link rel="stylesheet" href="css/animations.css">
</head>
<body>
  <button id="themeToggle" aria-pressed="false" aria-label="Toggle theme">üåô</button>
  <div id="sr-announcer" class="sr-only" aria-live="polite"></div>
  
  <!-- Game HUD -->
  <div id="gameHUD" class="game-hud">
    <div class="hud-item score-item">
      <span class="hud-label">Score</span>
      <span id="gameScore" class="hud-value">0</span>
    </div>
    <div class="hud-item timer-item">
      <span class="hud-label">Time</span>
      <span id="gameTimer" class="hud-value">0:00</span>
    </div>
    <div class="hud-item combo-item">
      <span id="gameCombo" class="hud-combo">√ó2 COMBO!</span>
    </div>
  </div>
  
  <div class="container">
    <h1>LUCY'S MATCH</h1>
    <div class="game-board" id="gameBoard">
      <!-- Cards will be injected by JS -->
    </div>
  </div>
  <!-- New elements for confetti and result modal -->
  <div id="confetti-container"></div>
  <div id="resultModal" role="dialog" aria-modal="true" aria-labelledby="resultTitle" onclick="restartGame()" style="cursor:pointer;" aria-hidden="true">
    <div class="modal-content">
      <h2 id="resultTitle">Game Over!</h2>
      <p id="starResult" aria-live="polite"></p>
      <p id="finalScore" class="final-score">Score: 0</p>
      <button id="playAgainBtn">Play Again</button>
    </div>
  </div>
  
  <!-- Title/Splash Screen -->
  <div class="title-screen" id="titleScreen">
    <div class="title-content">
      <h1 class="big-title">LUCY'S MATCH</h1>
      <p class="subtitle">üéÆ Memory Game üéÆ</p>
      <p class="tap-prompt">Tap anywhere to start!</p>
    </div>
  </div>
  
  <!-- Mode selection screen -->
  <div class="mode-screen" id="modeScreen" style="display: none;">
    <div class="mode-content">
      <h2>Choose Your Mode</h2>
      <div class="mode-buttons">
        <button class="mode-btn classic-btn" data-mode="classic">
          <span class="mode-emoji">üéØ</span>
          <span class="mode-name">Classic</span>
          <span class="mode-desc">Take your time!</span>
        </button>
        <button class="mode-btn timed-btn" data-mode="timed">
          <span class="mode-emoji">‚è±Ô∏è</span>
          <span class="mode-name">Timed</span>
          <span class="mode-desc">Complete boards!</span>
        </button>
        <button class="mode-btn blitz-btn" data-mode="blitz">
          <span class="mode-emoji">‚ö°</span>
          <span class="mode-name">Blitz</span>
          <span class="mode-desc">Max combos!</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Time selection screen for Timed mode -->
  <div class="time-screen" id="timeScreen" style="display: none;">
    <div class="time-content">
      <h2>‚è±Ô∏è Choose Your Challenge</h2>
      <div class="time-buttons">
        <button class="time-btn quick-time-btn" data-duration="60">
          <span class="time-emoji">‚è∞</span>
          <span class="time-name">Quick</span>
          <span class="time-desc">1 Minute</span>
        </button>
        <button class="time-btn standard-time-btn" data-duration="120">
          <span class="time-emoji">‚è≤Ô∏è</span>
          <span class="time-name">Standard</span>
          <span class="time-desc">2 Minutes</span>
        </button>
        <button class="time-btn marathon-time-btn" data-duration="180">
          <span class="time-emoji">‚è≥</span>
          <span class="time-name">Marathon</span>
          <span class="time-desc">3 Minutes</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Start modal element (difficulty selection) -->
  <div class="start-modal" id="startModal" style="display: none;">
    <div class="start-content">
      <h2>Choose Difficulty</h2>
      <div class="options">
        <button id="easyBtn" class="difficulty-btn easy-btn">
          <span class="diff-emoji">üü¢</span>
          <span class="diff-name">Easy</span>
          <span class="diff-count">8 cards</span>
        </button>
        <button id="mediumBtn" class="difficulty-btn medium-btn">
          <span class="diff-emoji">üü°</span>
          <span class="diff-name">Medium</span>
          <span class="diff-count">12 cards</span>
        </button>
        <button id="hardBtn" class="difficulty-btn hard-btn">
          <span class="diff-emoji">üî¥</span>
          <span class="diff-name">Hard</span>
          <span class="diff-count">16 cards</span>
        </button>
      </div>
    </div>
  </div>

  <script src="src/game.js"></script>
  <script>
    // Bootstrap browser behavior using the exported game API
    // Set the DOM board element that the game uses
    setGameBoardElement(document.getElementById('gameBoard'));
    // In the browser, use a longer mismatch delay so the flip animation is visible
    if (typeof setMismatchDelay === 'function') setMismatchDelay(1000);

    // Multi-step flow state
    let selectedMode = 'classic';

    // Title screen - tap anywhere to continue
    const titleScreen = document.getElementById('titleScreen');
    const modeScreen = document.getElementById('modeScreen');
    const startModal = document.getElementById('startModal');
    
    if (titleScreen) {
      titleScreen.addEventListener('click', () => {
        titleScreen.style.display = 'none';
        modeScreen.style.display = 'flex';
        if (typeof trapFocus === 'function') {
          // Focus first mode button
          const firstBtn = document.querySelector('.mode-btn');
          if (firstBtn) setTimeout(() => firstBtn.focus(), 100);
        }
      });
    }

    // Mode selection buttons
    const timeScreen = document.getElementById('timeScreen');
    let selectedTimeDuration = 120; // Default 2 minutes
    
    const modeButtons = document.querySelectorAll('.mode-btn');
    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedMode = btn.dataset.mode;
        modeScreen.style.display = 'none';
        
        // Blitz mode: fixed 4x5 grid (20 cards), skip difficulty selection
        if (selectedMode === 'blitz') {
          startGame(20, selectedMode);
          showHUD(selectedMode);
        }
        // If timed mode, show time selection screen
        else if (selectedMode === 'timed') {
          timeScreen.style.display = 'flex';
          if (typeof trapFocus === 'function') trapFocus(timeScreen);
        } else {
          // For classic, go straight to difficulty
          startModal.style.display = 'flex';
          if (typeof trapFocus === 'function') trapFocus(startModal);
        }
      });
    });

    // Time selection buttons (for timed mode)
    const timeButtons = document.querySelectorAll('.time-btn');
    timeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedTimeDuration = parseInt(btn.dataset.duration);
        timeScreen.style.display = 'none';
        startModal.style.display = 'flex';
        if (typeof trapFocus === 'function') trapFocus(startModal);
      });
    });

    // Wire difficulty buttons with mode selection
    document.getElementById('easyBtn').addEventListener('click', () => { 
      startGame(8, selectedMode, selectedMode === 'timed' ? selectedTimeDuration : null);
      startModal.style.display = 'none';
      showHUD(selectedMode);
    });
    document.getElementById('mediumBtn').addEventListener('click', () => { 
      startGame(12, selectedMode, selectedMode === 'timed' ? selectedTimeDuration : null);
      startModal.style.display = 'none';
      showHUD(selectedMode);
    });
    document.getElementById('hardBtn').addEventListener('click', () => { 
      startGame(16, selectedMode, selectedMode === 'timed' ? selectedTimeDuration : null);
      startModal.style.display = 'none';
      showHUD(selectedMode);
    });
    
    // Show/hide HUD based on mode
    function showHUD(mode) {
      const hud = document.getElementById('gameHUD');
      const timerItem = document.querySelector('.timer-item');
      const gameBoard = document.getElementById('gameBoard');
      
      if (hud) {
        hud.classList.add('active');
      }
      if (timerItem && (mode === 'timed' || mode === 'blitz')) {
        timerItem.classList.add('active');
      } else if (timerItem) {
        timerItem.classList.remove('active');
      }
      
      // Apply blitz-mode class for scaled layout
      if (gameBoard) {
        if (mode === 'blitz') {
          gameBoard.classList.add('blitz-mode');
        } else {
          gameBoard.classList.remove('blitz-mode');
        }
      }
    }

    // resultModal already has an onclick that calls restartGame() in the markup

    // Theme toggle wiring and initialization
    const themeToggle = document.getElementById('themeToggle');
    function updateToggleUI() {
      const current = typeof getTheme === 'function' ? getTheme() : 'light';
      if (!themeToggle) return;
      themeToggle.setAttribute('aria-pressed', current === 'dark' ? 'true' : 'false');
      themeToggle.textContent = current === 'dark' ? 'üåû' : 'üåô';
    }
    if (typeof initTheme === 'function') initTheme();
    updateToggleUI();
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        if (typeof toggleTheme === 'function') toggleTheme();
        updateToggleUI();
      });
    }
  </script>
</body>
</html>
