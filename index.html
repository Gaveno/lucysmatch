<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LUCY'S MATCH</title>
  <!-- Playful font -->
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- External CSS Files -->
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/hud.css">
  <link rel="stylesheet" href="css/modals.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/progression.css">
</head>
<body>
  <button id="themeToggle" aria-pressed="false" aria-label="Toggle theme">üåô</button>
  <div id="sr-announcer" class="sr-only" aria-live="polite"></div>
  
  <!-- Game HUD -->
  <div id="gameHUD" class="game-hud">
    <div class="hud-item score-item">
      <span class="hud-label">Score</span>
      <span id="gameScore" class="hud-value">0</span>
    </div>
    <div class="hud-item timer-item">
      <span class="hud-label">Time</span>
      <span id="gameTimer" class="hud-value">0:00</span>
    </div>
    <div class="hud-item combo-item">
      <span id="gameCombo" class="hud-combo">√ó2 COMBO!</span>
    </div>
  </div>
  
  <div class="container">
    <h1>LUCY'S MATCH</h1>
    <div class="game-board" id="gameBoard">
      <!-- Cards will be injected by JS -->
    </div>
  </div>
  <!-- New elements for confetti and result modal -->
  <div id="confetti-container"></div>
  <div id="resultModal" role="dialog" aria-modal="true" aria-labelledby="resultTitle" onclick="restartGame()" style="cursor:pointer;" aria-hidden="true">
    <div class="modal-content">
      <h2 id="resultTitle">Game Over!</h2>
      <p id="starResult" aria-live="polite"></p>
      <p id="finalScore" class="final-score">Score: 0</p>
      <button id="playAgainBtn">Play Again</button>
    </div>
  </div>
  
  <!-- Title/Splash Screen -->
  <div class="title-screen" id="titleScreen">
    <div class="title-content">
      <h1 class="big-title">LUCY'S MATCH</h1>
      <p class="subtitle">üéÆ Memory Game üéÆ</p>
      <p class="tap-prompt">Tap anywhere to start!</p>
    </div>
  </div>
  
  <!-- Mode selection screen -->
  <div class="mode-screen" id="modeScreen" style="display: none;">
    <div class="mode-content">
      <h2>Choose Your Mode</h2>
      <div class="mode-buttons">
        <button class="mode-btn classic-btn" data-mode="classic">
          <span class="mode-emoji">üéØ</span>
          <span class="mode-name">Classic</span>
          <span class="mode-desc">Take your time!</span>
        </button>
        <button class="mode-btn timed-btn" data-mode="timed">
          <span class="mode-emoji">‚è±Ô∏è</span>
          <span class="mode-name">Timed</span>
          <span class="mode-desc">Complete boards!</span>
        </button>
        <button class="mode-btn blitz-btn" data-mode="blitz">
          <span class="mode-emoji">‚ö°</span>
          <span class="mode-name">Blitz</span>
          <span class="mode-desc">Max combos!</span>
        </button>
      </div>
      <div class="progress-buttons">
        <button class="progress-btn" id="showAchievementsBtn">
          <span class="progress-btn-icon">üèÜ</span>
          <span>Achievements</span>
        </button>
        <button class="progress-btn" id="showHighScoresBtn">
          <span class="progress-btn-icon">üìä</span>
          <span>High Scores</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Time selection screen for Timed mode -->
  <div class="time-screen" id="timeScreen" style="display: none;">
    <div class="time-content">
      <h2>‚è±Ô∏è Choose Your Challenge</h2>
      <div class="time-buttons">
        <button class="time-btn quick-time-btn" data-duration="60">
          <span class="time-emoji">‚è∞</span>
          <span class="time-name">Quick</span>
          <span class="time-desc">1 Minute</span>
        </button>
        <button class="time-btn standard-time-btn" data-duration="120">
          <span class="time-emoji">‚è≤Ô∏è</span>
          <span class="time-name">Standard</span>
          <span class="time-desc">2 Minutes</span>
        </button>
        <button class="time-btn marathon-time-btn" data-duration="180">
          <span class="time-emoji">‚è≥</span>
          <span class="time-name">Marathon</span>
          <span class="time-desc">3 Minutes</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Start modal element (difficulty selection) -->
  <div class="start-modal" id="startModal" style="display: none;">
    <div class="start-content">
      <h2>Choose Difficulty</h2>
      <div class="options">
        <button id="easyBtn" class="difficulty-btn easy-btn">
          <span class="diff-emoji">üü¢</span>
          <span class="diff-name">Easy</span>
          <span class="diff-count">8 cards</span>
        </button>
        <button id="mediumBtn" class="difficulty-btn medium-btn">
          <span class="diff-emoji">üü°</span>
          <span class="diff-name">Medium</span>
          <span class="diff-count">12 cards</span>
        </button>
        <button id="hardBtn" class="difficulty-btn hard-btn">
          <span class="diff-emoji">üî¥</span>
          <span class="diff-name">Hard</span>
          <span class="diff-count">16 cards</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Achievements modal -->
  <div class="achievements-screen" id="achievementsScreen" style="display: none;">
    <div class="achievements-content">
      <h2>üèÜ Achievements</h2>
      
      <div class="player-stats">
        <div class="stat-item">
          <span class="stat-label">Level</span>
          <span class="stat-value" id="playerLevel">1</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Games Played</span>
          <span class="stat-value" id="gamesPlayed">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Perfect Games</span>
          <span class="stat-value" id="perfectGames">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Best Combo</span>
          <span class="stat-value" id="bestCombo">0</span>
        </div>
      </div>

      <div class="xp-bar-container">
        <div class="xp-info">
          <span id="currentXP">0 XP</span>
          <span id="nextLevelXP">100 XP</span>
        </div>
        <div class="xp-bar">
          <div class="xp-fill" id="xpFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="achievements-grid" id="achievementsGrid">
        <!-- Achievements will be populated by JavaScript -->
      </div>

      <button class="modal-close-btn" id="closeAchievementsBtn">Close</button>
    </div>
  </div>

  <!-- High Scores modal -->
  <div class="highscores-screen" id="highScoresScreen" style="display: none;">
    <div class="highscores-content">
      <h2>üìä High Scores</h2>
      
      <div class="mode-tabs">
        <button class="mode-tab active" data-score-mode="classic">Classic</button>
        <button class="mode-tab" data-score-mode="timed">Timed</button>
        <button class="mode-tab" data-score-mode="blitz">Blitz</button>
      </div>

      <div id="scoresDisplay">
        <!-- Scores will be populated by JavaScript -->
      </div>

      <button class="modal-close-btn" id="closeHighScoresBtn">Close</button>
    </div>
  </div>

  <script src="src/playerState.js"></script>
  <script src="src/game.js"></script>
  <script>
    // Bootstrap browser behavior using the exported game API
    // Set the DOM board element that the game uses
    setGameBoardElement(document.getElementById('gameBoard'));
    // In the browser, use a longer mismatch delay so the flip animation is visible
    if (typeof setMismatchDelay === 'function') setMismatchDelay(1000);

    // Multi-step flow state
    let selectedMode = 'classic';

    // Initialize player state
    const playerState = new PlayerState();

    // Title screen - tap anywhere to continue
    const titleScreen = document.getElementById('titleScreen');
    const modeScreen = document.getElementById('modeScreen');
    const startModal = document.getElementById('startModal');
    
    if (titleScreen) {
      titleScreen.addEventListener('click', () => {
        titleScreen.style.display = 'none';
        modeScreen.style.display = 'flex';
        if (typeof trapFocus === 'function') {
          // Focus first mode button
          const firstBtn = document.querySelector('.mode-btn');
          if (firstBtn) setTimeout(() => firstBtn.focus(), 100);
        }
      });
    }

    // Mode selection buttons
    const timeScreen = document.getElementById('timeScreen');
    let selectedTimeDuration = 120; // Default 2 minutes
    
    const modeButtons = document.querySelectorAll('.mode-btn');
    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedMode = btn.dataset.mode;
        modeScreen.style.display = 'none';
        
        // Blitz mode: fixed 4x5 grid (20 cards), skip difficulty selection
        if (selectedMode === 'blitz') {
          startGame(20, selectedMode);
          showHUD(selectedMode);
        }
        // If timed mode, show time selection screen
        else if (selectedMode === 'timed') {
          timeScreen.style.display = 'flex';
          if (typeof trapFocus === 'function') trapFocus(timeScreen);
        } else {
          // For classic, go straight to difficulty
          startModal.style.display = 'flex';
          if (typeof trapFocus === 'function') trapFocus(startModal);
        }
      });
    });

    // Time selection buttons (for timed mode)
    const timeButtons = document.querySelectorAll('.time-btn');
    timeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedTimeDuration = parseInt(btn.dataset.duration);
        timeScreen.style.display = 'none';
        startModal.style.display = 'flex';
        if (typeof trapFocus === 'function') trapFocus(startModal);
      });
    });

    // Wire difficulty buttons with mode selection
    document.getElementById('easyBtn').addEventListener('click', () => { 
      startGame(8, selectedMode, selectedMode === 'timed' ? selectedTimeDuration : null);
      startModal.style.display = 'none';
      showHUD(selectedMode);
    });
    document.getElementById('mediumBtn').addEventListener('click', () => { 
      startGame(12, selectedMode, selectedMode === 'timed' ? selectedTimeDuration : null);
      startModal.style.display = 'none';
      showHUD(selectedMode);
    });
    document.getElementById('hardBtn').addEventListener('click', () => { 
      startGame(16, selectedMode, selectedMode === 'timed' ? selectedTimeDuration : null);
      startModal.style.display = 'none';
      showHUD(selectedMode);
    });
    
    // Show/hide HUD based on mode
    function showHUD(mode) {
      const hud = document.getElementById('gameHUD');
      const timerItem = document.querySelector('.timer-item');
      const gameBoard = document.getElementById('gameBoard');
      
      if (hud) {
        hud.classList.add('active');
      }
      if (timerItem && (mode === 'timed' || mode === 'blitz')) {
        timerItem.classList.add('active');
      } else if (timerItem) {
        timerItem.classList.remove('active');
      }
      
      // Apply blitz-mode class for scaled layout
      if (gameBoard) {
        if (mode === 'blitz') {
          gameBoard.classList.add('blitz-mode');
        } else {
          gameBoard.classList.remove('blitz-mode');
        }
      }
    }

    // resultModal already has an onclick that calls restartGame() in the markup

    // Theme toggle wiring and initialization
    const themeToggle = document.getElementById('themeToggle');
    function updateToggleUI() {
      const current = typeof getTheme === 'function' ? getTheme() : 'light';
      if (!themeToggle) return;
      themeToggle.setAttribute('aria-pressed', current === 'dark' ? 'true' : 'false');
      themeToggle.textContent = current === 'dark' ? 'üåû' : 'üåô';
    }
    if (typeof initTheme === 'function') initTheme();
    updateToggleUI();
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        if (typeof toggleTheme === 'function') toggleTheme();
        updateToggleUI();
        playerState.recordThemeSwitch();
      });
    }

    // Achievements and High Scores functionality
    const achievementsScreen = document.getElementById('achievementsScreen');
    const highScoresScreen = document.getElementById('highScoresScreen');
    const showAchievementsBtn = document.getElementById('showAchievementsBtn');
    const showHighScoresBtn = document.getElementById('showHighScoresBtn');
    const closeAchievementsBtn = document.getElementById('closeAchievementsBtn');
    const closeHighScoresBtn = document.getElementById('closeHighScoresBtn');

    function showAchievementsModal() {
      const stats = playerState.getStats();
      const achievements = playerState.getAllAchievements();
      
      // Update stats display
      document.getElementById('playerLevel').textContent = stats.level;
      document.getElementById('gamesPlayed').textContent = stats.gamesPlayed;
      document.getElementById('perfectGames').textContent = stats.perfectGames;
      document.getElementById('bestCombo').textContent = stats.highestCombo;
      
      // Update XP bar
      const xpProgress = ((stats.xp % 50) / 50) * 100;
      document.getElementById('currentXP').textContent = `${stats.xp} XP`;
      document.getElementById('nextLevelXP').textContent = `${stats.xpForNextLevel} XP`;
      document.getElementById('xpFill').style.width = `${xpProgress}%`;
      
      // Populate achievements grid
      const achievementsGrid = document.getElementById('achievementsGrid');
      achievementsGrid.innerHTML = '';
      
      achievements.forEach(achievement => {
        const card = document.createElement('div');
        card.className = `achievement-card ${achievement.unlocked ? '' : 'locked'}`;
        
        let unlockedDate = '';
        if (achievement.unlocked && achievement.unlockedAt) {
          const date = new Date(achievement.unlockedAt);
          unlockedDate = `<div class="achievement-date">Unlocked ${date.toLocaleDateString()}</div>`;
        }
        
        card.innerHTML = `
          <span class="achievement-icon">${achievement.icon}</span>
          <div class="achievement-name">${achievement.name}</div>
          <div class="achievement-desc">${achievement.description}</div>
          <div class="achievement-xp">+${achievement.xpReward} XP</div>
          ${unlockedDate}
        `;
        
        achievementsGrid.appendChild(card);
      });
      
      achievementsScreen.style.display = 'flex';
    }

    function showHighScoresModal() {
      updateHighScoresDisplay('classic');
      highScoresScreen.style.display = 'flex';
    }

    function updateHighScoresDisplay(mode) {
      const scoresDisplay = document.getElementById('scoresDisplay');
      const highScores = playerState.getAllHighScores();
      const modeScores = highScores[mode] || {};
      
      scoresDisplay.innerHTML = '';
      
      ['easy', 'medium', 'hard'].forEach(difficulty => {
        const section = document.createElement('div');
        section.className = 'difficulty-section';
        
        const header = document.createElement('div');
        header.className = 'difficulty-header';
        header.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        section.appendChild(header);
        
        const score = modeScores[difficulty];
        
        if (score) {
          const row = document.createElement('div');
          row.className = 'score-row';
          
          row.innerHTML = `
            <div>
              <div class="score-label">Score</div>
              <div class="score-value">${score.score}</div>
            </div>
            <div>
              <div class="score-label">Mistakes</div>
              <div class="score-value">${score.mistakes || 0}</div>
            </div>
            <div>
              <div class="score-label">Time</div>
              <div class="score-value">${score.timeElapsed ? Math.floor(score.timeElapsed) + 's' : 'N/A'}</div>
            </div>
            <div>
              <div class="score-label">Max Combo</div>
              <div class="score-value">${score.maxCombo || 0}x</div>
            </div>
          `;
          
          section.appendChild(row);
        } else {
          const noScore = document.createElement('div');
          noScore.className = 'no-score';
          noScore.textContent = 'No score yet - play to set a record!';
          section.appendChild(noScore);
        }
        
        scoresDisplay.appendChild(section);
      });
    }

    // Event listeners for progress buttons
    if (showAchievementsBtn) {
      showAchievementsBtn.addEventListener('click', showAchievementsModal);
    }

    if (showHighScoresBtn) {
      showHighScoresBtn.addEventListener('click', showHighScoresModal);
    }

    if (closeAchievementsBtn) {
      closeAchievementsBtn.addEventListener('click', () => {
        achievementsScreen.style.display = 'none';
      });
    }

    if (closeHighScoresBtn) {
      closeHighScoresBtn.addEventListener('click', () => {
        highScoresScreen.style.display = 'none';
      });
    }

    // Mode tabs for high scores
    document.querySelectorAll('.mode-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        updateHighScoresDisplay(tab.dataset.scoreMode);
      });
    });

    // Show achievement unlock notification
    function showAchievementNotification(achievement) {
      const notification = document.createElement('div');
      notification.className = 'achievement-unlock-notification';
      notification.innerHTML = `
        <span class="achievement-unlock-icon">${achievement.icon}</span>
        <div class="achievement-unlock-content">
          <div class="achievement-unlock-title">Achievement Unlocked!</div>
          <div class="achievement-unlock-name">${achievement.name}</div>
          <div class="achievement-unlock-xp">+${achievement.xpReward} XP</div>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 4000);
    }

    // Show level up notification
    function showLevelUpNotification(level) {
      const notification = document.createElement('div');
      notification.className = 'level-up-notification';
      notification.innerHTML = `
        <div class="level-up-title">Level Up!</div>
        <div class="level-up-number">${level}</div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 2000);
    }

    // Expose to window for game.js
    window.showAchievementNotification = showAchievementNotification;
    window.showLevelUpNotification = showLevelUpNotification;
    window.playerState = playerState;
  </script>
</body>
</html>
